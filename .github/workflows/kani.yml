name: Kani Verification

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  kani-config:
    name: Config & Constants
    runs-on: self-hosted
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify configuration and constants
        run: |
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_nonce_len_constant
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_magic_bytes
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_salt_len_bound
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_argon2_defaults

      - name: Verify CryptoConfig properties
        run: |
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_default_matches_constants
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_new_preserves_values
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_fast_is_faster
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_paranoid_is_stronger
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_no_parameter_overflow

  kani-nonce:
    name: Nonce Safety (Critical)
    runs-on: self-hosted
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # CRITICAL: Nonce uniqueness verification for streaming encryption
      # Nonce reuse in AES-GCM is catastrophic - it breaks authentication and allows key recovery
      - name: Verify streaming nonce safety
        run: |
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_nonce_uniqueness_different_indices
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_counter_injection
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_nonce_structure
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_nonce_length
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_sequential_nonce_uniqueness
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_zero_index_valid
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_max_index_valid

  kani-memory:
    name: Memory Protection
    runs-on: self-hosted
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify memory protection properties
        run: |
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_scrub_pattern_distinctness
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_custom_pattern_value
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_custom_pattern_uniqueness
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_pattern_pass_counts
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_nonce_entropy
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_chacha_key_length
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_allocation_size_bounds
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_pool_stats_no_overflow
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_security_level_ordering
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_zero_scrub_result
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_ones_scrub_result
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_chacha_length_preserving

  kani-volume:
    name: Volume Header
    runs-on: self-hosted
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify volume header properties
        run: |
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_header_size_alignment
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_cipher_algorithm_values
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_pq_algorithm_values
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_pq_metadata_size_bounds
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_mlkem1024_key_sizes
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_yubikey_flag_operations
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_flag_is_single_bit
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_sector_size_bounds
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_volume_size_no_overflow
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_pq_metadata_offset
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_has_pqc_conditions
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_checksum_size
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_salt_size
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_header_iv_size
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_version_constants
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_encrypted_dk_size
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_sphincs_padding
