name: Kani Verification

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  kani-verify:
    name: Kani Formal Verification
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libglib2.0-dev libatk1.0-dev libgdk-pixbuf2.0-dev libcairo2-dev libpango1.0-dev libxdo-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Kani installation
        id: cache-kani
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-kani
          key: ${{ runner.os }}-kani-${{ hashFiles('.github/workflows/kani.yml') }}

      - name: Install Kani
        if: steps.cache-kani.outputs.cache-hit != 'true'
        run: |
          cargo install --locked kani-verifier
          cargo kani setup

      - name: Run Kani setup (if cached)
        if: steps.cache-kani.outputs.cache-hit == 'true'
        run: cargo kani setup

      # Note: Harnesses that call actual crypto operations (AES-GCM, Argon2) fail
      # because those libraries use inline assembly (cpuid) for CPU feature detection.
      # See: https://github.com/model-checking/kani/issues/2
      #
      # These harnesses verify configuration bounds, constants, and API contracts
      # without triggering inline assembly.
      - name: Verify configuration and constants
        run: |
          echo "::group::Kani Verification - Configuration & Constants"
          # Use --no-default-features to exclude GUI deps (eframe->image->rav1e) that conflict with Kani's nightly
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_nonce_len_constant
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_magic_bytes
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_salt_len_bound
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_argon2_defaults
          echo "::endgroup::"

      - name: Verify CryptoConfig properties
        run: |
          echo "::group::Kani Verification - CryptoConfig"
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_default_matches_constants
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_new_preserves_values
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_fast_is_faster
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_paranoid_is_stronger
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_no_parameter_overflow
          echo "::endgroup::"
