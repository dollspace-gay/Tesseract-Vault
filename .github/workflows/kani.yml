name: Kani Verification

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # Shared setup job that other jobs depend on
  kani-config:
    name: Config & Constants
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libglib2.0-dev libatk1.0-dev libgdk-pixbuf2.0-dev libcairo2-dev libpango1.0-dev libxdo-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Kani installation
        id: cache-kani
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-kani
          key: ${{ runner.os }}-kani-${{ hashFiles('.github/workflows/kani.yml') }}

      - name: Install Kani
        if: steps.cache-kani.outputs.cache-hit != 'true'
        run: |
          cargo install --locked kani-verifier
          cargo kani setup

      - name: Run Kani setup (if cached)
        if: steps.cache-kani.outputs.cache-hit == 'true'
        run: cargo kani setup

      # Note: Harnesses that call actual crypto operations (AES-GCM, Argon2) fail
      # because those libraries use inline assembly (cpuid) for CPU feature detection.
      - name: Verify configuration and constants
        run: |
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_nonce_len_constant
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_magic_bytes
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_salt_len_bound
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_argon2_defaults

      - name: Verify CryptoConfig properties
        run: |
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_default_matches_constants
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_new_preserves_values
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_fast_is_faster
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_config_paranoid_is_stronger
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_no_parameter_overflow

  kani-nonce:
    name: Nonce Safety (Critical)
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libglib2.0-dev libatk1.0-dev libgdk-pixbuf2.0-dev libcairo2-dev libpango1.0-dev libxdo-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Kani installation
        id: cache-kani
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-kani
          key: ${{ runner.os }}-kani-${{ hashFiles('.github/workflows/kani.yml') }}

      - name: Install Kani
        if: steps.cache-kani.outputs.cache-hit != 'true'
        run: |
          cargo install --locked kani-verifier
          cargo kani setup

      - name: Run Kani setup (if cached)
        if: steps.cache-kani.outputs.cache-hit == 'true'
        run: cargo kani setup

      # CRITICAL: Nonce uniqueness verification for streaming encryption
      # Nonce reuse in AES-GCM is catastrophic - it breaks authentication and allows key recovery
      - name: Verify streaming nonce safety
        run: |
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_nonce_uniqueness_different_indices
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_counter_injection
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_nonce_structure
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_nonce_length
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_sequential_nonce_uniqueness
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_zero_index_valid
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_max_index_valid

  kani-memory:
    name: Memory Protection
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libglib2.0-dev libatk1.0-dev libgdk-pixbuf2.0-dev libcairo2-dev libpango1.0-dev libxdo-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Kani installation
        id: cache-kani
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-kani
          key: ${{ runner.os }}-kani-${{ hashFiles('.github/workflows/kani.yml') }}

      - name: Install Kani
        if: steps.cache-kani.outputs.cache-hit != 'true'
        run: |
          cargo install --locked kani-verifier
          cargo kani setup

      - name: Run Kani setup (if cached)
        if: steps.cache-kani.outputs.cache-hit == 'true'
        run: cargo kani setup

      - name: Verify memory protection properties
        run: |
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_scrub_pattern_distinctness
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_custom_pattern_value
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_custom_pattern_uniqueness
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_pattern_pass_counts
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_nonce_entropy
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_chacha_key_length
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_allocation_size_bounds
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_pool_stats_no_overflow
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_security_level_ordering
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_zero_scrub_result
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_ones_scrub_result
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_chacha_length_preserving

  kani-volume:
    name: Volume Header
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libglib2.0-dev libatk1.0-dev libgdk-pixbuf2.0-dev libcairo2-dev libpango1.0-dev libxdo-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Kani installation
        id: cache-kani
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-kani
          key: ${{ runner.os }}-kani-${{ hashFiles('.github/workflows/kani.yml') }}

      - name: Install Kani
        if: steps.cache-kani.outputs.cache-hit != 'true'
        run: |
          cargo install --locked kani-verifier
          cargo kani setup

      - name: Run Kani setup (if cached)
        if: steps.cache-kani.outputs.cache-hit == 'true'
        run: cargo kani setup

      - name: Verify volume header properties
        run: |
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_header_size_alignment
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_cipher_algorithm_values
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_pq_algorithm_values
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_pq_metadata_size_bounds
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_mlkem1024_key_sizes
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_yubikey_flag_operations
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_flag_is_single_bit
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_sector_size_bounds
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_volume_size_no_overflow
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_pq_metadata_offset
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_has_pqc_conditions
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_checksum_size
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_salt_size
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_header_iv_size
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_version_constants
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_encrypted_dk_size
          cargo kani --lib --no-default-features --features "post-quantum,compression" --harness verify_sphincs_padding
